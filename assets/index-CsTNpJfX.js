import{r as d,j as e,D as Be,a as $e,b as We,T as fe,F as _,I as K,S as Se,M as C,c as Ve,d as T,C as te,R as Ge,e as re,f as He,B as se,u as _e,g as Ke,A as qe,h as Qe,i as E,k as N,l as Xe,P as Ze,m as Ye,G as et,n as tt,o as oe,p as rt,L as G,q as ot,s as H,t as nt,v as st,w as ae,x as at,y as it,z as lt,E as je,H as ne,J as ct,K as ke,N as dt,O as pt,Q as ut,U as ht}from"./vendor-C8mXMOc3.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))x(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&x(l)}).observe(document,{childList:!0,subtree:!0});function u(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function x(n){if(n.ep)return;n.ep=!0;const r=u(n);fetch(n.href,r)}})();function mt({location:o,gpsMeta:s,onClose:u,onSave:x}){const[n,r]=d.useState({name:"",description:"",type:"",transportModes:{wheelchair:!1,electricVan:!1,walking:!1},gender:""}),[l,p]=d.useState(""),c=(a,f)=>{r(S=>({...S,[a]:f}))},h=a=>{r(f=>({...f,transportModes:{...f.transportModes,[a]:!f.transportModes[a]}}))},g=()=>{if(!n.name.trim()){p("نام گره را وارد کنید");return}const a=Object.keys(n.transportModes).filter(f=>n.transportModes[f]);x({...n,latitude:o.lat,longitude:o.lng,timestamp:new Date().toISOString(),transportModes:a,gpsMeta:s?{coords:{latitude:s.coords.latitude,longitude:s.coords.longitude,accuracy:s.coords.accuracy,altitude:s.coords.altitude,speed:s.coords.speed,heading:s.coords.heading},timestamp:s.timestamp}:null}),u()};return e.jsxs(Be,{open:!0,onClose:u,maxWidth:"sm",fullWidth:!0,children:[e.jsx($e,{sx:{textAlign:"center",fontWeight:"bold"},children:"ایجاد گره جدید"}),e.jsxs(We,{dividers:!0,children:[l&&e.jsx("div",{style:{color:"red",marginBottom:"16px",textAlign:"center"},children:l}),e.jsx(fe,{label:"نام گره",fullWidth:!0,margin:"normal",value:n.name,onChange:a=>c("name",a.target.value),required:!0}),e.jsx(fe,{label:"توضیحات",fullWidth:!0,margin:"normal",multiline:!0,rows:3,value:n.description,onChange:a=>c("description",a.target.value)}),e.jsxs(_,{fullWidth:!0,margin:"normal",children:[e.jsx(K,{children:"نوع گره"}),e.jsxs(Se,{value:n.type,onChange:a=>c("type",a.target.value),label:"نوع گره",children:[e.jsx(C,{value:"checkpoint",children:"نقطه بازرسی"}),e.jsx(C,{value:"landmark",children:"نشانه"}),e.jsx(C,{value:"poi",children:"نقطه دلخواه"}),e.jsx(C,{value:"other",children:"سایر"})]})]}),e.jsxs(_,{component:"fieldset",fullWidth:!0,margin:"normal",children:[e.jsx(K,{shrink:!0,children:"شیوه‌های حمل و نقل"}),e.jsxs(Ve,{children:[e.jsx(T,{control:e.jsx(te,{checked:n.transportModes.wheelchair,onChange:()=>h("wheelchair")}),label:"ویلچر"}),e.jsx(T,{control:e.jsx(te,{checked:n.transportModes.electricVan,onChange:()=>h("electricVan")}),label:"ون برقی"}),e.jsx(T,{control:e.jsx(te,{checked:n.transportModes.walking,onChange:()=>h("walking")}),label:"پیاده‌روی"})]})]}),e.jsxs(_,{component:"fieldset",fullWidth:!0,margin:"normal",children:[e.jsx(K,{shrink:!0,children:"جنسیت تردد"}),e.jsxs(Ge,{value:n.gender,onChange:a=>c("gender",a.target.value),children:[e.jsx(T,{value:"male",control:e.jsx(re,{}),label:"مردانه"}),e.jsx(T,{value:"female",control:e.jsx(re,{}),label:"زنانه"}),e.jsx(T,{value:"family",control:e.jsx(re,{}),label:"خانوادگی"})]})]})]}),e.jsxs(He,{children:[e.jsx(se,{onClick:u,color:"secondary",children:"انصراف"}),e.jsx(se,{onClick:g,color:"primary",variant:"contained",children:"ذخیره"})]})]})}const xt=()=>{const[o,s]=d.useState(()=>{const r=localStorage.getItem("mapMarkers");return r?JSON.parse(r):[]});return d.useEffect(()=>{localStorage.setItem("mapMarkers",JSON.stringify(o))},[o]),{markers:o,addMarker:r=>{s(l=>[...l,{...r,id:crypto.randomUUID(),timestamp:new Date().toISOString()}])},removeMarker:r=>{s(l=>l.filter(p=>p.id!==r))},updateMarker:(r,l)=>{s(p=>p.map(c=>c.id===r?{...c,...l}:c))}}};function ye(o){return Array.isArray(o)?typeof o[0]=="object"&&Array.isArray(o[0].coordinates)?o.map(s=>s.coordinates):o:[]}const gt=()=>{const[o,s]=d.useState(()=>{const r=localStorage.getItem("mapPaths");return r?JSON.parse(r):[]});return d.useEffect(()=>{localStorage.setItem("mapPaths",JSON.stringify(o))},[o]),{paths:o,addPath:r=>{s(l=>[...l,{...r,id:crypto.randomUUID(),timestamp:new Date().toISOString()}])},removePath:r=>{s(l=>l.filter(p=>p.id!==r))},updatePath:(r,l)=>{s(p=>p.map(c=>c.id===r?{...c,...l}:c))}}},ft=(o="geojson")=>{const s=JSON.parse(localStorage.getItem("mapMarkers")||"[]"),u=JSON.parse(localStorage.getItem("mapPaths")||"[]");let x,n,r;switch(o){case"geojson":const g={type:"FeatureCollection",features:[...s.map(i=>({type:"Feature",geometry:{type:"Point",coordinates:[i.position[1],i.position[0]]},properties:i.data||{}})),...u.map(i=>({type:"Feature",geometry:{type:"LineString",coordinates:Array.isArray(i.coordinates)?typeof i.coordinates[0]=="object"&&Array.isArray(i.coordinates[0].coordinates)?i.coordinates.map(y=>[y.coordinates[1],y.coordinates[0]]):i.coordinates.map(y=>[y[1],y[0]]):[]},properties:{name:i.name,description:i.description,type:i.type,timestamp:i.timestamp,pointsMeta:Array.isArray(i.coordinates)?typeof i.coordinates[0]=="object"&&i.coordinates[0].gpsMeta?i.coordinates.map(y=>y.gpsMeta):[]:[]}}))]};x=JSON.stringify(g,null,2),n="application/geo+json",r="geojson";break;case"kml":const a="<?xml …>",f="</Document></kml>",S=u.map(i=>{const v=ye(i.coordinates).map(P=>`${P[1]},${P[0]},0`).join(" ");return`
    <Placemark>
      <name>${i.name||"Unnamed Path"}</name>
      <description>${i.description||""}</description>
      <LineString>
        <coordinates>
          ${v}
        </coordinates>
      </LineString>
    </Placemark>`}).join("");x=a+pointsKML+S+f,n="application/vnd.google-earth.kml+xml",r="kml";break;case"csv":const M=`Type,Name,Description,Latitude,Longitude,Timestamp
`,b=s.map(i=>{var y,v;return`Point,"${((y=i.data)==null?void 0:y.name)||""}","${((v=i.data)==null?void 0:v.description)||""}",${i.position[0]},${i.position[1]},"${i.timestamp}"`}).join(`
`),j=u.map(i=>{const y=ye(i.coordinates),[v,P]=y[0]||["",""];return`Line,"${i.name}","${i.description}",${v},${P},"${i.timestamp}"`}).join(`
`);x=M+b+(b&&j?`
`:"")+j,n="text/csv",r="csv";break;default:const k={version:"1.0",exportDate:new Date().toISOString(),markers:s,paths:u};x=JSON.stringify(k,null,2),n="application/json",r="json"}const l=new Blob([x],{type:n}),p=URL.createObjectURL(l),c=`map_export_${new Date().toISOString().replace(/[:.]/g,"-")}.${r}`,h=document.createElement("a");h.href=p,h.download=c,document.body.appendChild(h),h.click(),document.body.removeChild(h),URL.revokeObjectURL(p)},jt=o=>new Promise((s,u)=>{const x=new FileReader;x.onload=n=>{let r;try{r=JSON.parse(n.target.result)}catch{return u(new Error("Invalid JSON"))}if(r.version&&r.markers&&r.paths){const l=JSON.parse(localStorage.getItem("mapMarkers")||"[]"),p=JSON.parse(localStorage.getItem("mapPaths")||"[]"),c=r.markers.map(f=>({...f,id:crypto.randomUUID()})),h=r.paths.map(f=>({...f,id:crypto.randomUUID()})),g=l.concat(c),a=p.concat(h);return localStorage.setItem("mapMarkers",JSON.stringify(g)),localStorage.setItem("mapPaths",JSON.stringify(a)),s({markers:g,paths:a})}if(r.type==="FeatureCollection"&&Array.isArray(r.features)){const l=JSON.parse(localStorage.getItem("mapMarkers")||"[]"),p=JSON.parse(localStorage.getItem("mapPaths")||"[]"),c=[],h=[];r.features.forEach(f=>{const{geometry:S,properties:M={}}=f;if(S){if(S.type==="Point"){const[b,j]=S.coordinates;c.push({id:crypto.randomUUID(),position:[j,b],data:M,timestamp:M.timestamp||new Date().toISOString()})}else if(S.type==="LineString"){const b=S.coordinates.map(([j,k])=>[k,j]);h.push({id:crypto.randomUUID(),name:M.name||"",description:M.description||"",type:M.type||"",coordinates:b,timestamp:M.timestamp||new Date().toISOString()})}}});const g=l.concat(c),a=p.concat(h);return localStorage.setItem("mapMarkers",JSON.stringify(g)),localStorage.setItem("mapPaths",JSON.stringify(a)),s({markers:g,paths:a})}u(new Error("Invalid import file format"))},x.onerror=()=>u(new Error("File read error")),x.readAsText(o)});function yt({isTracking:o,onStartTracking:s,onStopTracking:u,onAddMarker:x,onExport:n,onImportClick:r,onFilter:l,onStartManualPath:p,isDrawingPath:c}){const h=_e(),a=Ke(h.breakpoints.down("sm"))?"small":"medium",[f,S]=d.useState(null),M=j=>{S(j.currentTarget)},b=j=>{S(null),j&&typeof n=="function"&&n(j)};return e.jsx(qe,{position:"fixed",color:"inherit",sx:{top:"auto",bottom:0},children:e.jsxs(Qe,{sx:{justifyContent:"space-around"},children:[e.jsx(E,{title:o?"توقف ردیابی":"شروع ردیابی",arrow:!0,children:e.jsx(N,{color:o?"error":"success",onClick:o?u:s,size:a,children:o?e.jsx(Xe,{}):e.jsx(Ze,{})})}),e.jsx(E,{title:"نشانگر",arrow:!0,children:e.jsx(N,{color:"primary",onClick:x,size:a,children:e.jsx(Ye,{})})}),e.jsx(E,{title:"مسیر دستی",arrow:!0,children:e.jsx(N,{color:c?"success":"primary",onClick:p,size:a,children:e.jsx(et,{})})}),e.jsx(E,{title:"فیلتر",arrow:!0,children:e.jsx(N,{color:"secondary",onClick:l,size:a,children:e.jsx(tt,{})})}),e.jsx(E,{title:"خروجی",arrow:!0,children:e.jsx(N,{color:"warning",onClick:M,size:a,children:e.jsx(oe,{})})}),e.jsxs(rt,{anchorEl:f,open:!!f,onClose:()=>b(),children:[e.jsxs(C,{onClick:()=>b("geojson"),children:[e.jsx(G,{children:e.jsx(ot,{fontSize:"small"})}),e.jsx(H,{children:"GeoJSON"})]}),e.jsxs(C,{onClick:()=>b("kml"),children:[e.jsx(G,{children:e.jsx(nt,{fontSize:"small"})}),e.jsx(H,{children:"KML"})]}),e.jsxs(C,{onClick:()=>b("csv"),children:[e.jsx(G,{children:e.jsx(oe,{fontSize:"small"})}),e.jsx(H,{children:"CSV"})]}),e.jsxs(C,{onClick:()=>b("json"),children:[e.jsx(G,{children:e.jsx(oe,{fontSize:"small"})}),e.jsx(H,{children:"JSON"})]})]}),e.jsx(E,{title:"ورودی",arrow:!0,children:e.jsx(N,{color:"inherit",onClick:r,size:a,children:e.jsx(st,{})})})]})})}const St=ae.divIcon({className:"custom-marker-icon",html:`
    <div style="
      width: 30px; 
      height: 30px; 
      background-color: #2196F3; 
      border-radius: 50%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      color: white; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    ">
      📍
    </div>
  `,iconSize:[30,30],iconAnchor:[15,15]}),kt=({selectedItem:o,onDelete:s,onClose:u})=>{var l,p,c,h,g,a,f,S,M,b;const x=j=>!j||j.length===0?"ندارد":j.map(k=>{switch(k){case"wheelchair":return"ویلچر";case"electricVan":return"ون برقی";case"walking":return"پیاده‌روی";default:return k}}).join(", "),n=j=>Array.isArray(j)?Array.isArray(j[0])?j:j.map(k=>k.coordinates||[]):[],r=j=>{const k=n(j);if(k.length<2)return 0;let i=0;for(let y=1;y<k.length;y++){const[v,P]=k[y-1],[z,q]=k[y];i+=ae.latLng(v,P).distanceTo(ae.latLng(z,q))}return(i/1e3).toFixed(2)};return e.jsxs("div",{style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",backgroundColor:"white",padding:"20px",borderRadius:"10px",boxShadow:"0 4px 15px rgba(0,0,0,0.2)",width:"90%",maxWidth:"400px",maxHeight:"80vh",overflowY:"auto",zIndex:1e3},children:[e.jsxs("h2",{style:{marginBottom:"15px",textAlign:"center",color:"#333"},children:["جزئیات ",o.type==="marker"?"نشانگر":"مسیر"]}),e.jsxs("div",{style:{backgroundColor:"#f4f4f4",padding:"15px",borderRadius:"8px",marginBottom:"15px"},children:[e.jsxs("p",{children:[e.jsx("strong",{children:"نام:"})," ",((l=o.item.data)==null?void 0:l.name)||o.item.name||"بدون نام"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"توضیحات:"})," ",((p=o.item.data)==null?void 0:p.description)||o.item.description||"بدون توضیحات"]})]}),o.type==="marker"&&e.jsxs("div",{style:{backgroundColor:"#e9f5e9",padding:"15px",borderRadius:"8px",marginBottom:"15px"},children:[e.jsxs("p",{children:[e.jsx("strong",{children:"نوع نشانگر:"})," ",((c=o.item.data)==null?void 0:c.type)||"نامشخص"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"شیوه‌های حمل و نقل:"})," ",x((h=o.item.data)==null?void 0:h.transportModes)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"جنسیت تردد:"}),((g=o.item.data)==null?void 0:g.gender)==="male"?"مردانه":((a=o.item.data)==null?void 0:a.gender)==="female"?"زنانه":((f=o.item.data)==null?void 0:f.gender)==="family"?"خانوادگی":"نامشخص"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"موقعیت مکانی:"}),`${o.item.position[0].toFixed(4)}, ${o.item.position[1].toFixed(4)}`]})]}),o.type==="path"&&e.jsxs("div",{style:{backgroundColor:"#e6f2ff",padding:"15px",borderRadius:"8px",marginBottom:"15px"},children:[e.jsxs("p",{children:[e.jsx("strong",{children:"نوع مسیر:"})," ",o.item.type||"نامشخص"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"طول مسیر:"})," ",r(o.item.coordinates)," کیلومتر"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"تعداد نقاط مسیر:"})," ",((S=o.item.coordinates)==null?void 0:S.length)||0]}),e.jsxs("p",{children:[e.jsx("strong",{children:"تاریخ ایجاد:"})," ",new Date(o.item.timestamp).toLocaleDateString("fa-IR")]}),e.jsxs("p",{children:[e.jsx("strong",{children:"دقت GPS:"}),(b=(M=o.item.gpsMeta)==null?void 0:M.coords)!=null&&b.accuracy?`${o.item.gpsMeta.coords.accuracy} متر`:"اطلاعات موجود نیست"]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:"15px"},children:[e.jsxs("button",{onClick:s,style:{backgroundColor:"#dc3545",color:"white",border:"none",padding:"10px 20px",borderRadius:"5px",display:"flex",alignItems:"center",gap:"10px"},children:[e.jsx("span",{children:"🗑️"})," بله، حذف شود"]}),e.jsxs("button",{onClick:u,style:{backgroundColor:"#6c757d",color:"white",border:"none",padding:"10px 20px",borderRadius:"5px",display:"flex",alignItems:"center",gap:"10px"},children:[e.jsx("span",{children:"✖"})," انصراف"]})]})]})};function bt({onSave:o,onClose:s,pathCoordinates:u}){const[x,n]=d.useState(""),[r,l]=d.useState(""),[p,c]=d.useState(""),h=()=>{if(!x.trim()){alert("نام مسیر را وارد کنید");return}const g={name:x,description:r,type:p,coordinates:u,timestamp:new Date().toISOString()};o(g),s()};return e.jsxs("div",{style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",backgroundColor:"white",padding:"20px",borderRadius:"10px",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",zIndex:1e3,width:"90%",maxWidth:"400px"},children:[e.jsx("h2",{children:"ذخیره‌سازی مسیر"}),e.jsxs("div",{style:{marginBottom:"10px"},children:[e.jsx("label",{children:"نام مسیر:"}),e.jsx("input",{type:"text",value:x,onChange:g=>n(g.target.value),placeholder:"نام مسیر را وارد کنید",style:{width:"100%",padding:"5px"},required:!0})]}),e.jsxs("div",{style:{marginBottom:"10px"},children:[e.jsx("label",{children:"توضیحات:"}),e.jsx("textarea",{value:r,onChange:g=>l(g.target.value),placeholder:"توضیحات مسیر را وارد کنید",style:{width:"100%",padding:"5px",minHeight:"100px"}})]}),e.jsxs("div",{style:{marginBottom:"10px"},children:[e.jsx("label",{children:"نوع مسیر:"}),e.jsxs("select",{value:p,onChange:g=>c(g.target.value),style:{width:"100%",padding:"5px"},children:[e.jsx("option",{value:"",children:"انتخاب نوع مسیر"}),e.jsx("option",{value:"hiking",children:"پیاده‌روی"}),e.jsx("option",{value:"driving",children:"رانندگی"}),e.jsx("option",{value:"other",children:"سایر"})]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[e.jsx("button",{onClick:h,style:{padding:"10px",backgroundColor:"green",color:"white",border:"none",borderRadius:"5px"},children:"ذخیره"}),e.jsx("button",{onClick:s,style:{padding:"10px",backgroundColor:"red",color:"white",border:"none",borderRadius:"5px"},children:"انصراف"})]})]})}function Mt({onMapClick:o}){return ut({click:s=>{o(s.latlng)}}),null}function wt({position:o,zoom:s}){const u=pt();return d.useEffect(()=>{o&&u.setView(o,s)},[o,s]),null}function vt({isOpen:o,onClose:s,filterOptions:u,setFilterOptions:x}){if(!o)return null;const n=(r,l)=>{x(p=>{const c=p[r]||[],h=c.includes(l)?c.filter(g=>g!==l):[...c,l];return{...p,[r]:h}})};return e.jsxs("div",{style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",backgroundColor:"white",padding:"20px",borderRadius:"10px",boxShadow:"0 4px 15px rgba(0,0,0,0.2)",zIndex:1e3,width:"90%",maxWidth:"400px"},children:[e.jsx("h2",{children:"فیلترسازی"}),e.jsxs("div",{children:[e.jsx("h3",{children:"نوع نشانگر"}),["checkpoint","landmark","poi","other"].map(r=>e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:u.markerTypes.includes(r),onChange:()=>n("markerTypes",r)}),r==="checkpoint"&&"نقطه بازرسی",r==="landmark"&&"نشانه",r==="poi"&&"نقطه دلخواه",r==="other"&&"سایر"]},r))]}),e.jsxs("div",{children:[e.jsx("h3",{children:"نوع مسیر"}),["hiking","driving","other"].map(r=>e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:u.pathTypes.includes(r),onChange:()=>n("pathTypes",r)}),r==="hiking"&&"پیاده‌روی",r==="driving"&&"رانندگی",r==="other"&&"سایر"]},r))]}),e.jsx("button",{onClick:s,children:"بستن"})]})}const Ct=()=>{const[o,s]=d.useState([36.2972,59.6067]),[u,x]=d.useState(12),[n,r]=d.useState(null),[l,p]=d.useState(null),[c,h]=d.useState([]),[g,a]=d.useState(null),[f,S]=d.useState(null),[M,b]=d.useState(!1),[j,k]=d.useState(!1),[i,y]=d.useState(null),[v,P]=d.useState(!1),[z,q]=d.useState("street"),F=d.useRef(null),[J,ie]=d.useState(null),[B,Q]=d.useState(!1),[R,$]=d.useState([]),[be,le]=d.useState([]),[X,Z]=d.useState(null),Me=(t="json")=>{ft(t)},[I,we]=d.useState({markerTypes:[],pathTypes:[],transportModes:[],gender:[]}),ve={street:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",satellite:"https://tiles.maps.eox.at/wmts/1.0.0/s2cloudless-2020_3857/default/g/{z}/{y}/{x}.jpg"},{markers:ce,addMarker:de,removeMarker:pe}=xt(),{paths:ue,addPath:Y,removePath:he}=gt(),W=d.useRef(null),me=d.useCallback(()=>{if(a(null),!navigator.geolocation){a("موقعیت مکانی در دستگاه شما پشتیبانی نمی‌شود");return}const t={enableHighAccuracy:!0,timeout:3e4,maximumAge:0};navigator.geolocation.getCurrentPosition(m=>{const{latitude:O,longitude:A,accuracy:w}=m.coords,L=[O,A];r(L),ie(m),p(w),s(L),x(15)},m=>{switch(m.code){case m.PERMISSION_DENIED:a("دسترسی به موقعیت مکانی رد شد");break;case m.POSITION_UNAVAILABLE:a("اطلاعات موقعیت در دسترس نیست");break;case m.TIMEOUT:a("زمان درخواست موقعیت مکانی به پایان رسید");break;default:a("خطا در دریافت موقعیت مکانی")}s([36.2972,59.6067]),x(12)},t)},[]),Ce=()=>{Q(!0),$([]),a(null)},Pe=()=>{R.length>1?(Z("manual"),k(!0)):a("مسیر بسیار کوتاه است. حداقل دو نقطه نیاز است.")},Ie=d.useRef(c);d.useEffect(()=>{Ie.current=c},[c]);const Oe=()=>{b(!0),h([]),a(null),F.current&&clearTimeout(F.current),F.current=setTimeout(()=>{h(t=>(t.length===0&&(ee(),a("عدم موفقیت در دریافت موقعیت مکانی. لطفاً مجدداً تلاش کنید.")),t))},3e4),W.current=navigator.geolocation.watchPosition(t=>{console.log("GPS update:",t.coords.latitude,t.coords.longitude,"accuracy:",t.coords.accuracy),ie(t);const{latitude:m,longitude:O,accuracy:A,altitude:w,speed:L,heading:V}=t.coords,U=[m,O];clearTimeout(F.current),A<=5e3&&(r(U),a(null),h(D=>{if(D.length===0)return[...D,U];const xe=D[D.length-1],ge=1e-6;return Math.abs(xe[0]-m)>ge||Math.abs(xe[1]-O)>ge?[...D,U]:D}),le(D=>[...D,{coords:{latitude:m,longitude:O,accuracy:A,altitude:w,speed:L,heading:V},timestamp:t.timestamp}]))},t=>{console.error("Tracking error:",t),clearTimeout(F.current);let m="خطا در دریافت موقعیت";switch(t.code){case t.PERMISSION_DENIED:m="دسترسی به موقعیت مکانی رد شد";break;case t.POSITION_UNAVAILABLE:m="اطلاعات موقعیت در دسترس نیست";break;case t.TIMEOUT:m="زمان درخواست موقعیت مکانی به پایان رسید";break}a(m),ee()},{enableHighAccuracy:!0,timeout:3e4,maximumAge:0,distanceFilter:1})},ee=()=>{W.current&&(navigator.geolocation.clearWatch(W.current),W.current=null),b(!1),c.length>1?(Z("gps"),k(!0)):(h([]),a("مسیر بسیار کوتاه است. لطفاً مسافت بیشتری را طی کنید."))},Ae=t=>{y({type:"marker",item:t})},De=t=>{y({type:"path",item:t})},Le=()=>{if(i){const{type:t,item:m}=i;t==="marker"?pe(m.id):t==="path"&&he(m.id),y(null)}},Te=t=>{Y({...t,coordinates:c,pointsMeta:be}),k(!1),h([]),le([])};d.useEffect(()=>{me()},[me]);const Ee=t=>{B?$(m=>[...m,{coordinates:[t.lat,t.lng],gpsMeta:J?{coords:{...J.coords},timestamp:J.timestamp}:null}]):S({lat:t.lat,lng:t.lng})},Ne=t=>{de({position:[t.latitude,t.longitude],data:t}),S(null)},Fe=t=>{const m=t.target.files[0];m&&jt(m).then(({markers:O,paths:A})=>{ce.forEach(w=>pe(w.id)),ue.forEach(w=>he(w.id)),O.forEach(w=>de(w)),A.forEach(w=>Y(w)),alert("اطلاعات با موفقیت وارد شد!")})},Re=ce.filter(t=>{var w,L,V;const m=I.markerTypes.length===0||I.markerTypes.includes((w=t.data)==null?void 0:w.type),O=I.transportModes.length===0||((L=t.data)==null?void 0:L.transportModes)&&t.data.transportModes.some(U=>I.transportModes.includes(U)),A=I.gender.length===0||I.gender.includes((V=t.data)==null?void 0:V.gender);return m&&O&&A}),Ue=ue.filter(t=>I.pathTypes.length===0||I.pathTypes.includes(t.type)),ze=t=>{Y({...t,coordinates:R}),k(!1),$([]),Q(!1)},Je=t=>{switch(t){case"hiking":return"#4CAF50";case"cycling":return"#2196F3";case"driving":return"#FF9800";default:return"#9C27B0"}};return e.jsxs("div",{className:"map-container",children:[e.jsx(at,{sx:{position:"absolute",top:"10px",right:"10px",backgroundColor:"#ffffffee",padding:"10px",borderRadius:"8px",zIndex:1200,boxShadow:"0 2px 6px rgba(0,0,0,0.15)",direction:"rtl",minWidth:"180px"},children:e.jsxs(_,{fullWidth:!0,variant:"outlined",size:"small",children:[e.jsx(K,{id:"map-layer-label",style:{right:"0px",fontWeight:"bold"},children:"نقشه پایه"}),e.jsxs(Se,{labelId:"map-layer-label",id:"map-layer-select",value:z,label:"نقشه پایه",onChange:t=>q(t.target.value),children:[e.jsx(C,{value:"street",children:"Street View"}),e.jsx(C,{value:"satellite",children:"Satellite View"})]})]})}),j&&e.jsx(bt,{onSave:X==="manual"?ze:Te,onClose:()=>{k(!1),X==="manual"?($([]),Q(!1)):h([]),Z(null)},pathCoordinates:X==="manual"?R:c}),f&&e.jsx(mt,{location:f,gpsMeta:J,onClose:()=>S(null),onSave:Ne}),v&&e.jsx(vt,{isOpen:v,onClose:()=>P(!1),filterOptions:I,setFilterOptions:we}),i&&e.jsx(kt,{selectedItem:i,onDelete:Le,onClose:()=>y(null)}),e.jsxs(it,{center:o,zoom:u,scrollWheelZoom:!0,style:{width:"100%",height:"100%",position:"absolute",margin:0,padding:0,direction:"rtl"},children:[e.jsx(wt,{position:o,zoom:u}),e.jsx(Mt,{onMapClick:Ee}),e.jsx(lt,{url:ve[z],attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}),n&&l&&e.jsxs(e.Fragment,{children:[e.jsx(je,{center:n,radius:l,color:"blue",fillColor:"blue",fillOpacity:.1,weight:2}),e.jsx(je,{center:n,radius:5,color:"blue",fillColor:"blue",fillOpacity:1,weight:0})]}),c.length>0&&e.jsx(ne,{positions:c,color:"blue",weight:5,opacity:M?.7:1}),B&&R.length>0&&e.jsx(ne,{positions:R.map(t=>t.coordinates),color:"blue",weight:5,opacity:.7}),Re.map(t=>e.jsx(ct,{position:t.position,icon:St,eventHandlers:{click:()=>Ae(t)}},t.id)),Ue.map(t=>(Array.isArray(t.coordinates)&&typeof t.coordinates[0]=="object"&&Array.isArray(t.coordinates[0].coordinates)?t.coordinates.map(m=>m.coordinates):Array.isArray(t.coordinates[0])&&t.coordinates,e.jsx(ke.Fragment,{children:e.jsx(ne,{positions:Array.isArray(t.coordinates)&&t.coordinates.length>0?typeof t.coordinates[0]=="object"&&Array.isArray(t.coordinates[0].coordinates)?t.coordinates.map(m=>m.coordinates):t.coordinates:[],color:Je(t.type),weight:5,opacity:.7,eventHandlers:{click:()=>De(t)},children:e.jsx(dt,{children:e.jsxs("div",{children:[e.jsx("strong",{children:t.name}),e.jsx("p",{children:t.description}),e.jsxs("p",{children:["نوع مسیر: ",t.type]})]})})})},t.id)))]}),e.jsx(yt,{isTracking:M,onStartTracking:Oe,onStopTracking:ee,onAddMarker:()=>S({lat:o[0],lng:o[1]}),onExport:Me,onImportClick:()=>document.getElementById("importInput").click(),onFilter:()=>P(!0),onStartManualPath:Ce,isDrawingPath:B}),B&&e.jsx(se,{onClick:Pe,variant:"contained",color:"success",style:{position:"fixed",bottom:70,right:20,zIndex:9999},children:"پایان مسیر و ذخیره"}),e.jsx("input",{id:"importInput",type:"file",accept:".json",onChange:Fe,style:{display:"none"}})]})};ht.createRoot(document.getElementById("root")).render(e.jsx(ke.StrictMode,{children:e.jsx(Ct,{})}));
