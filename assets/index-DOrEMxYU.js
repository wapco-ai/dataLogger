import{r as g,j as e,D as de,a as ue,b as pe,T as K,F as z,I as J,S as he,M as T,c as te,d as C,C as W,R as ve,e as H,f as ge,B as U,g as _,h as R,P as ze,i as jt,k as yt,l as E,m as bt,A as kt,n as St,o as N,p as Je,q as Ue,L as vt,s as Mt,t as Be,u as Ve,v as ee,w as ce,G as wt,E as Ge,x as Pt,y as He,z as Ct,H as Dt,J as Ot,K as It,N as At,O as Tt,Q as Et,U as Lt,V as Rt,W as $t,X as ie,Y as Nt,Z as le,_ as Ft,$ as Ne,a0 as Wt,a1 as zt,a2 as Jt,a3 as Ut,a4 as Bt,a5 as Fe,a6 as Vt,a7 as _e,a8 as Gt,a9 as Ht,aa as _t}from"./vendor-BfpjCLxU.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))u(c);new MutationObserver(c=>{for(const t of c)if(t.type==="childList")for(const a of t.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&u(a)}).observe(document,{childList:!0,subtree:!0});function d(c){const t={};return c.integrity&&(t.integrity=c.integrity),c.referrerPolicy&&(t.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?t.credentials="include":c.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function u(c){if(c.ep)return;c.ep=!0;const t=d(c);fetch(c.href,t)}})();function Zt({location:n,gpsMeta:o,onClose:d,onSave:u}){const[c,t]=g.useState({name:"",description:"",type:"",transportModes:{wheelchair:!1,electricVan:!1,walking:!1},gender:""}),[a,p]=g.useState(""),m=(l,i)=>{t(f=>({...f,[l]:i}))},j=l=>{t(i=>({...i,transportModes:{...i.transportModes,[l]:!i.transportModes[l]}}))},y=()=>{if(!c.name.trim()){p("نام گره را وارد کنید");return}const l=Object.keys(c.transportModes).filter(i=>c.transportModes[i]);u({...c,latitude:n.lat,longitude:n.lng,timestamp:new Date().toISOString(),transportModes:l,gpsMeta:o?{coords:{latitude:o.coords.latitude,longitude:o.coords.longitude,accuracy:o.coords.accuracy,altitude:o.coords.altitude,speed:o.coords.speed,heading:o.coords.heading},timestamp:o.timestamp}:null}),d()};return e.jsxs(de,{open:!0,onClose:d,maxWidth:"sm",dir:"rtl",fullWidth:!0,children:[e.jsx(ue,{sx:{textAlign:"center",fontWeight:"bold"},children:"ایجاد گره جدید"}),e.jsxs(pe,{dividers:!0,sx:{direction:"rtl"},children:[a&&e.jsx("div",{style:{color:"red",marginBottom:"16px",textAlign:"center"},children:a}),e.jsx(K,{label:"نام گره",fullWidth:!0,margin:"normal",value:c.name,onChange:l=>m("name",l.target.value),required:!0,sx:{direction:"rtl"}}),e.jsx(K,{label:"توضیحات",fullWidth:!0,margin:"normal",multiline:!0,rows:3,value:c.description,onChange:l=>m("description",l.target.value),sx:{direction:"rtl"}}),e.jsxs(z,{fullWidth:!0,margin:"normal",children:[e.jsx(J,{children:"نوع گره"}),e.jsxs(he,{value:c.type,onChange:l=>m("type",l.target.value),label:"نوع گره",children:[e.jsx(T,{value:"checkpoint",children:"نقطه بازرسی"}),e.jsx(T,{value:"landmark",children:"نشانه"}),e.jsx(T,{value:"poi",children:"نقطه دلخواه"}),e.jsx(T,{value:"other",children:"سایر"})]})]}),e.jsxs(z,{component:"fieldset",fullWidth:!0,margin:"normal",children:[e.jsx(J,{shrink:!0,children:"شیوه‌های حمل و نقل"}),e.jsxs(te,{children:[e.jsx(C,{control:e.jsx(W,{checked:c.transportModes.wheelchair,onChange:()=>j("wheelchair")}),label:"ویلچر"}),e.jsx(C,{control:e.jsx(W,{checked:c.transportModes.electricVan,onChange:()=>j("electricVan")}),label:"ون برقی"}),e.jsx(C,{control:e.jsx(W,{checked:c.transportModes.walking,onChange:()=>j("walking")}),label:"پیاده‌روی"})]})]}),e.jsxs(z,{component:"fieldset",fullWidth:!0,margin:"normal",children:[e.jsx(J,{shrink:!0,children:"جنسیت تردد"}),e.jsxs(ve,{value:c.gender,onChange:l=>m("gender",l.target.value),children:[e.jsx(C,{value:"male",control:e.jsx(H,{}),label:"مردانه"}),e.jsx(C,{value:"female",control:e.jsx(H,{}),label:"زنانه"}),e.jsx(C,{value:"family",control:e.jsx(H,{}),label:"خانوادگی"})]})]})]}),e.jsxs(ge,{children:[e.jsx(U,{onClick:d,color:"secondary",children:"انصراف"}),e.jsx(U,{onClick:y,color:"primary",variant:"contained",children:"ذخیره"})]})]})}function qt({onSave:n,onClose:o,pathCoordinates:d}){const[u,c]=g.useState({name:"",description:"",type:"",transportModes:{wheelchair:!1,electricVan:!1,walking:!1},gender:""}),[t,a]=g.useState(""),p=(y,l)=>{c(i=>({...i,[y]:l}))},m=y=>{c(l=>({...l,transportModes:{...l.transportModes,[y]:!l.transportModes[y]}}))},j=()=>{if(!u.name.trim()){a("نام مسیر را وارد کنید");return}const y=Object.keys(u.transportModes).filter(l=>u.transportModes[l]);n({...u,transportModes:y,coordinates:d,timestamp:new Date().toISOString()}),o()};return e.jsxs(de,{open:!0,onClose:o,maxWidth:"sm",dir:"rtl",fullWidth:!0,children:[e.jsx(ue,{sx:{textAlign:"center",fontWeight:"bold"},children:"ایجاد مسیر جدید"}),e.jsxs(pe,{dividers:!0,children:[t&&e.jsx("div",{style:{color:"red",marginBottom:"16px",textAlign:"center"},children:t}),e.jsx(K,{label:"نام مسیر",fullWidth:!0,margin:"normal",value:u.name,onChange:y=>p("name",y.target.value),required:!0}),e.jsx(K,{label:"توضیحات",fullWidth:!0,margin:"normal",multiline:!0,rows:3,value:u.description,onChange:y=>p("description",y.target.value)}),e.jsxs(z,{fullWidth:!0,margin:"normal",children:[e.jsx(J,{children:"نوع مسیر"}),e.jsxs(he,{value:u.type,onChange:y=>p("type",y.target.value),label:"نوع مسیر",children:[e.jsx(T,{value:"hiking",children:"پیاده‌روی"}),e.jsx(T,{value:"driving",children:"رانندگی"}),e.jsx(T,{value:"other",children:"سایر"})]})]}),e.jsxs(z,{component:"fieldset",fullWidth:!0,margin:"normal",children:[e.jsx(J,{shrink:!0,children:"شیوه‌های حمل و نقل"}),e.jsxs(te,{children:[e.jsx(C,{control:e.jsx(W,{checked:u.transportModes.wheelchair,onChange:()=>m("wheelchair")}),label:"ویلچر"}),e.jsx(C,{control:e.jsx(W,{checked:u.transportModes.electricVan,onChange:()=>m("electricVan")}),label:"ون برقی"}),e.jsx(C,{control:e.jsx(W,{checked:u.transportModes.walking,onChange:()=>m("walking")}),label:"پیاده‌روی"})]})]}),e.jsxs(z,{component:"fieldset",fullWidth:!0,margin:"normal",children:[e.jsx(J,{shrink:!0,children:"جنسیت تردد"}),e.jsxs(ve,{value:u.gender,onChange:y=>p("gender",y.target.value),children:[e.jsx(C,{value:"male",control:e.jsx(H,{}),label:"مردانه"}),e.jsx(C,{value:"female",control:e.jsx(H,{}),label:"زنانه"}),e.jsx(C,{value:"family",control:e.jsx(H,{}),label:"خانوادگی"})]})]})]}),e.jsxs(ge,{children:[e.jsx(U,{onClick:o,color:"secondary",children:"انصراف"}),e.jsx(U,{onClick:j,color:"primary",variant:"contained",children:"ذخیره"})]})]})}const Kt=[{key:"saturday",label:"شنبه"},{key:"sunday",label:"یک‌شنبه"},{key:"monday",label:"دوشنبه"},{key:"tuesday",label:"سه‌شنبه"},{key:"wednesday",label:"چهارشنبه"},{key:"thursday",label:"پنج‌شنبه"},{key:"friday",label:"جمعه"}];function Xt({onSave:n,onClose:o,polygonCoordinates:d}){const[u,c]=g.useState({name:"",description:"",type:"",transportModes:{wheelchair:!1,electricVan:!1,walking:!1},gender:""}),[t,a]=g.useState(""),[p,m]=g.useState({}),j=(i,f)=>c(k=>({...k,[i]:f})),y=i=>c(f=>({...f,transportModes:{...f.transportModes,[i]:!f.transportModes[i]}})),l=()=>{if(!u.name.trim()){a("نام محدوده را وارد کنید");return}const i=Object.keys(u.transportModes).filter(f=>u.transportModes[f]);n({...u,transportModes:i,coordinates:d,restrictedTimes:p,timestamp:new Date().toISOString()}),o()};return e.jsxs(de,{open:!0,onClose:o,maxWidth:"sm",dir:"rtl",fullWidth:!0,children:[e.jsx(ue,{sx:{textAlign:"center",fontWeight:"bold"},children:"ایجاد محدوده جدید"}),e.jsxs(pe,{dividers:!0,children:[t&&e.jsx("div",{style:{color:"red",marginBottom:16,textAlign:"center"},children:t}),e.jsx(K,{label:"نام محدوده",fullWidth:!0,margin:"normal",value:u.name,onChange:i=>j("name",i.target.value),required:!0}),e.jsx(K,{label:"توضیحات",fullWidth:!0,margin:"normal",multiline:!0,rows:3,value:u.description,onChange:i=>j("description",i.target.value)}),e.jsxs(z,{fullWidth:!0,margin:"normal",children:[e.jsx(J,{children:"نوع محدوده"}),e.jsxs(he,{value:u.type,onChange:i=>j("type",i.target.value),label:"نوع محدوده",children:[e.jsx(T,{value:"park",children:"پارک"}),e.jsx(T,{value:"zone",children:"محدوده"}),e.jsx(T,{value:"other",children:"سایر"})]})]}),e.jsxs(z,{component:"fieldset",fullWidth:!0,margin:"normal",children:[e.jsx(J,{shrink:!0,children:"شیوه‌های حمل و نقل"}),e.jsxs(te,{children:[e.jsx(C,{control:e.jsx(W,{checked:u.transportModes.wheelchair,onChange:()=>y("wheelchair")}),label:"ویلچر"}),e.jsx(C,{control:e.jsx(W,{checked:u.transportModes.electricVan,onChange:()=>y("electricVan")}),label:"ون برقی"}),e.jsx(C,{control:e.jsx(W,{checked:u.transportModes.walking,onChange:()=>y("walking")}),label:"پیاده‌روی"})]})]}),e.jsxs(z,{component:"fieldset",fullWidth:!0,margin:"normal",children:[e.jsx(J,{shrink:!0,children:"جنسیت تردد"}),e.jsxs(ve,{value:u.gender,onChange:i=>j("gender",i.target.value),children:[e.jsx(C,{value:"male",control:e.jsx(H,{}),label:"مردانه"}),e.jsx(C,{value:"female",control:e.jsx(H,{}),label:"زنانه"}),e.jsx(C,{value:"family",control:e.jsx(H,{}),label:"خانوادگی"})]})]}),e.jsx(_,{variant:"subtitle1",sx:{fontWeight:"bold",mt:2,mb:1},children:e.jsx("span",{style:{borderBottom:"2px solid #999",paddingBottom:3},children:"زمان‌های محدودیت دسترسی"})}),e.jsx(R,{children:Kt.map(i=>e.jsxs(ze,{elevation:p[i.key]?2:0,sx:{mb:1,borderRadius:3,p:1,bgcolor:p[i.key]?"#f5f5f5":"transparent",transition:"background .2s"},children:[e.jsx(R,{display:"flex",alignItems:"center",children:e.jsx(C,{control:e.jsx(jt,{checked:!!p[i.key],color:"primary",onChange:f=>{m(k=>f.target.checked?{...k,[i.key]:[{start:"",end:""}]}:Object.fromEntries(Object.entries(k).filter(([S])=>S!==i.key)))}}),label:e.jsx(_,{sx:{fontWeight:"bold"},children:i.label}),labelPlacement:"start",sx:{flex:1,mr:1}})}),e.jsx(yt,{in:!!p[i.key],children:e.jsxs(R,{mt:1,pl:2,pr:1,children:[(p[i.key]||[]).map((f,k)=>e.jsxs(R,{display:"flex",alignItems:"center",mb:1,children:[e.jsx(K,{size:"small",label:"از",type:"time",value:f.start,onChange:S=>{const w=S.target.value;m(h=>({...h,[i.key]:h[i.key].map((x,M)=>M===k?{...x,start:w}:x)}))},variant:"outlined",sx:{width:105,mx:.5,direction:"ltr",bgcolor:"#fff"},InputLabelProps:{shrink:!0,sx:{right:0,fontWeight:"bold"}},inputProps:{step:300,dir:"ltr",style:{textAlign:"center"}}}),e.jsx(_,{variant:"body2",sx:{mx:1},children:"تا"}),e.jsx(K,{size:"small",label:"تا",type:"time",value:f.end,onChange:S=>{const w=S.target.value;m(h=>({...h,[i.key]:h[i.key].map((x,M)=>M===k?{...x,end:w}:x)}))},variant:"outlined",sx:{width:105,mx:.5,direction:"ltr",bgcolor:"#fff"},InputLabelProps:{shrink:!0,sx:{right:0,fontWeight:"bold"}},inputProps:{step:300,dir:"ltr",style:{textAlign:"center"}}}),e.jsx(E,{onClick:()=>m(S=>({...S,[i.key]:S[i.key].filter((w,h)=>h!==k)})),size:"small",color:"error",sx:{mx:.5},disabled:p[i.key].length===1,children:e.jsx(bt,{fontSize:"small"})})]},k)),e.jsx(U,{onClick:()=>m(f=>({...f,[i.key]:[...f[i.key],{start:"",end:""}]})),color:"primary",size:"small",startIcon:e.jsx(kt,{}),sx:{mt:1,fontWeight:"bold"},children:"افزودن بازه"})]})})]},i.key))})]}),e.jsxs(ge,{children:[e.jsx(U,{onClick:o,color:"secondary",children:"انصراف"}),e.jsx(U,{onClick:l,color:"primary",variant:"contained",children:"ذخیره"})]})]})}const Qt=[{value:"checkpoint",label:"نقطه بازرسی"},{value:"landmark",label:"نشانه"},{value:"poi",label:"نقطه دلخواه"},{value:"other",label:"سایر"}],Yt=[{value:"hiking",label:"پیاده‌روی"},{value:"driving",label:"رانندگی"},{value:"other",label:"سایر"}];function en({isOpen:n,onClose:o,filterOptions:d,setFilterOptions:u}){const c=(t,a)=>{u(p=>{const m=p[t]||[];return{...p,[t]:m.includes(a)?m.filter(j=>j!==a):[...m,a]}})};return e.jsxs(de,{open:n,onClose:o,maxWidth:"xs",fullWidth:!0,dir:"rtl",children:[e.jsx(ue,{sx:{fontWeight:"bold",textAlign:"center"},children:"فیلترسازی"}),e.jsxs(pe,{children:[e.jsxs(R,{sx:{mb:2},children:[e.jsx(_,{variant:"subtitle1",sx:{fontWeight:"bold",mb:1},children:"نوع نشانگر"}),e.jsx(te,{children:Qt.map(t=>e.jsx(C,{control:e.jsx(W,{checked:d.markerTypes.includes(t.value),onChange:()=>c("markerTypes",t.value)}),label:t.label},t.value))})]}),e.jsx(St,{sx:{my:1}}),e.jsxs(R,{children:[e.jsx(_,{variant:"subtitle1",sx:{fontWeight:"bold",mb:1},children:"نوع مسیر"}),e.jsx(te,{children:Yt.map(t=>e.jsx(C,{control:e.jsx(W,{checked:d.pathTypes.includes(t.value),onChange:()=>c("pathTypes",t.value)}),label:t.label},t.value))})]})]}),e.jsx(ge,{children:e.jsx(U,{onClick:o,color:"primary",fullWidth:!0,variant:"contained",sx:{fontWeight:"bold",borderRadius:2},children:"بستن"})})]})}const tn=({selectedItem:n,onDelete:o,onClose:d})=>{var a,p,m,j,y,l,i,f,k,S,w;const u=h=>!h||h.length===0?"ندارد":h.map(x=>{switch(x){case"wheelchair":return"ویلچر";case"electricVan":return"ون برقی";case"walking":return"پیاده‌روی";default:return x}}).join(", "),c=h=>Array.isArray(h)?Array.isArray(h[0])?h:h.map(x=>x.coordinates||[]):[],t=h=>{const x=c(h);if(x.length<2)return 0;let M=0;for(let D=1;D<x.length;D++){const[I,F]=x[D-1],[s,b]=x[D];M+=L.latLng(I,F).distanceTo(L.latLng(s,b))}return(M/1e3).toFixed(2)};return e.jsxs("div",{style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",backgroundColor:"white",padding:"20px",borderRadius:"10px",boxShadow:"0 4px 15px rgba(0,0,0,0.2)",width:"90%",maxWidth:"400px",maxHeight:"80vh",overflowY:"auto",zIndex:1e3},children:[e.jsxs("h2",{style:{marginBottom:"15px",textAlign:"center",color:"#333"},children:["جزئیات ",n.type==="marker"?"نشانگر":n.type==="path"?"مسیر":n.type==="polygon"?"محدوده":""]}),e.jsxs("div",{style:{backgroundColor:"#f4f4f4",padding:"15px",borderRadius:"8px",marginBottom:"15px"},children:[e.jsxs("p",{children:[e.jsx("strong",{children:"نام:"})," ",((a=n.item.data)==null?void 0:a.name)||n.item.name||"بدون نام"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"توضیحات:"})," ",((p=n.item.data)==null?void 0:p.description)||n.item.description||"بدون توضیحات"]})]}),n.type==="marker"&&e.jsxs("div",{style:{backgroundColor:"#e9f5e9",padding:"15px",borderRadius:"8px",marginBottom:"15px"},children:[e.jsxs("p",{children:[e.jsx("strong",{children:"نوع نشانگر:"})," ",((m=n.item.data)==null?void 0:m.type)||"نامشخص"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"شیوه‌های حمل و نقل:"})," ",u((j=n.item.data)==null?void 0:j.transportModes)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"جنسیت تردد:"}),((y=n.item.data)==null?void 0:y.gender)==="male"?"مردانه":((l=n.item.data)==null?void 0:l.gender)==="female"?"زنانه":((i=n.item.data)==null?void 0:i.gender)==="family"?"خانوادگی":"نامشخص"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"موقعیت مکانی:"}),`${n.item.position[0].toFixed(4)}, ${n.item.position[1].toFixed(4)}`]})]}),n.type==="path"&&e.jsxs("div",{style:{backgroundColor:"#e6f2ff",padding:"15px",borderRadius:"8px",marginBottom:"15px"},children:[e.jsxs("p",{children:[e.jsx("strong",{children:"نوع مسیر:"})," ",n.item.type||"نامشخص"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"طول مسیر:"})," ",t(n.item.coordinates)," کیلومتر"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"تعداد نقاط مسیر:"})," ",((f=n.item.coordinates)==null?void 0:f.length)||0]}),e.jsxs("p",{children:[e.jsx("strong",{children:"تاریخ ایجاد:"})," ",new Date(n.item.timestamp).toLocaleDateString("fa-IR")]}),e.jsxs("p",{children:[e.jsx("strong",{children:"دقت GPS:"}),(S=(k=n.item.gpsMeta)==null?void 0:k.coords)!=null&&S.accuracy?`${n.item.gpsMeta.coords.accuracy} متر`:"اطلاعات موجود نیست"]})]}),n.type==="polygon"&&e.jsxs("div",{style:{backgroundColor:"#f5f4e6",padding:"15px",borderRadius:"8px",marginBottom:"15px"},children:[e.jsxs("p",{children:[e.jsx("strong",{children:"نام محدوده:"})," ",n.item.name||"بدون نام"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"توضیحات:"})," ",n.item.description||"بدون توضیحات"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"نوع محدوده:"})," ",n.item.type||"نامشخص"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"شیوه‌های حمل و نقل:"})," ",(n.item.transportModes||[]).join(", ")||"ندارد"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"جنسیت تردد:"})," ",n.item.gender==="male"?"مردانه":n.item.gender==="female"?"زنانه":n.item.gender==="family"?"خانوادگی":"نامشخص"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"تعداد نقاط:"})," ",((w=n.item.coordinates)==null?void 0:w.length)||0]}),e.jsxs("p",{children:[e.jsx("strong",{children:"تاریخ ایجاد:"})," ",new Date(n.item.timestamp).toLocaleDateString("fa-IR")]}),e.jsxs("p",{children:[e.jsx("strong",{children:"زمان‌های محدودیت:"}),e.jsx("br",{}),n.item.restrictedTimes&&Object.keys(n.item.restrictedTimes).length>0?e.jsx("ul",{style:{margin:0,paddingRight:18},children:Object.entries(n.item.restrictedTimes).map(([h,x])=>e.jsxs("li",{children:[e.jsx("span",{style:{fontWeight:"bold"},children:{saturday:"شنبه",sunday:"یک‌شنبه",monday:"دوشنبه",tuesday:"سه‌شنبه",wednesday:"چهارشنبه",thursday:"پنج‌شنبه",friday:"جمعه"}[h]}),":"," ",x.map((M,D)=>e.jsxs("span",{children:[M.start," - ",M.end,D<x.length-1?" ، ":""]},D))]},h))}):"محدودیتی ثبت نشده است"]})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:"15px"},children:[e.jsxs("button",{onClick:o,style:{backgroundColor:"#dc3545",color:"white",border:"none",padding:"10px 20px",borderRadius:"5px",display:"flex",alignItems:"center",gap:"10px"},children:[e.jsx("span",{children:"🗑️"})," بله، حذف شود"]}),e.jsxs("button",{onClick:d,style:{backgroundColor:"#6c757d",color:"white",border:"none",padding:"10px 20px",borderRadius:"5px",display:"flex",alignItems:"center",gap:"10px"},children:[e.jsx("span",{children:"✖"})," انصراف"]})]})]})},nn=()=>{const[n,o]=g.useState(()=>{const t=localStorage.getItem("mapMarkers");return t?JSON.parse(t):[]});return g.useEffect(()=>{localStorage.setItem("mapMarkers",JSON.stringify(n))},[n]),{markers:n,addMarker:t=>{o(a=>[...a,{...t,id:crypto.randomUUID(),timestamp:new Date().toISOString()}])},removeMarker:t=>{o(a=>a.filter(p=>p.id!==t))},updateMarker:(t,a)=>{o(p=>p.map(m=>m.id===t?{...m,...a}:m))}}},rn=()=>{const[n,o]=g.useState(()=>{const t=localStorage.getItem("mapPaths");return t?JSON.parse(t):[]});return g.useEffect(()=>{localStorage.setItem("mapPaths",JSON.stringify(n))},[n]),{paths:n,addPath:t=>{o(a=>[...a,{...t,id:crypto.randomUUID(),timestamp:new Date().toISOString()}])},removePath:t=>{o(a=>a.filter(p=>p.id!==t))},updatePath:(t,a)=>{o(p=>p.map(m=>m.id===t?{...m,...a}:m))}}},sn=()=>{const[n,o]=g.useState(()=>{const t=localStorage.getItem("mapPolygons");return t?JSON.parse(t):[]});return g.useEffect(()=>{localStorage.setItem("mapPolygons",JSON.stringify(n))},[n]),{polygons:n,addPolygon:t=>{o(a=>[...a,{...t,id:crypto.randomUUID(),timestamp:new Date().toISOString()}])},removePolygon:t=>{o(a=>a.filter(p=>p.id!==t))},updatePolygon:(t,a)=>{o(p=>p.map(m=>m.id===t?{...m,...a}:m))}}},on=(n="geojson")=>{const o=JSON.parse(localStorage.getItem("mapMarkers")||"[]"),d=JSON.parse(localStorage.getItem("mapPaths")||"[]"),u=JSON.parse(localStorage.getItem("mapPolygons")||"[]");let c,t,a;function p(i){return Array.isArray(i)?i.join(","):typeof i=="object"&&i!==null?Object.entries(i).filter(([f,k])=>k).map(([f])=>f).join(","):""}switch(n){case"geojson":const i={type:"FeatureCollection",features:[...o.map(s=>{var b,P;return{type:"Feature",geometry:{type:"Point",coordinates:[s.position[1],s.position[0]]},properties:{...s.data||{},transportModes:((b=s.data)==null?void 0:b.transportModes)||[],gender:((P=s.data)==null?void 0:P.gender)||""}}}),...d.map(s=>({type:"Feature",geometry:{type:"LineString",coordinates:Array.isArray(s.coordinates)?typeof s.coordinates[0]=="object"&&Array.isArray(s.coordinates[0].coordinates)?s.coordinates.map(b=>[b.coordinates[1],b.coordinates[0]]):s.coordinates.map(b=>[b[1],b[0]]):[]},properties:{name:s.name,description:s.description,type:s.type,timestamp:s.timestamp,transportModes:s.transportModes||[],gender:s.gender||""}})),...u.map(s=>({type:"Feature",geometry:{type:"Polygon",coordinates:[s.coordinates.map(b=>[b[1],b[0]])]},properties:{name:s.name,description:s.description,type:s.type,timestamp:s.timestamp,transportModes:s.transportModes||[],gender:s.gender||"",restrictedTimes:s.restrictedTimes||{}}}))]};c=JSON.stringify(i,null,2),t="application/geo+json",a="geojson";break;case"kml":const f=`<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
`,k=`</Document>
</kml>`,S=o.map(s=>{const b=s.data||{},P=p(b.transportModes);return`
      <Placemark>
        <name>${b.name||""}</name>
        <description>${b.description||""}</description>
        <ExtendedData>
          <Data name="type"><value>${b.type||""}</value></Data>
          <Data name="transportModes"><value>${P}</value></Data>
          <Data name="gender"><value>${b.gender||""}</value></Data>
        </ExtendedData>
        <Point>
          <coordinates>${s.position[1]},${s.position[0]},0</coordinates>
        </Point>
      </Placemark>
      `}).join(""),w=d.map(s=>{const P=(Array.isArray(s.coordinates)?typeof s.coordinates[0]=="object"&&Array.isArray(s.coordinates[0].coordinates)?s.coordinates.map($=>$.coordinates):s.coordinates:[]).map($=>`${$[1]},${$[0]},0`).join(" "),A=p(s.transportModes);return`
      <Placemark>
        <name>${s.name||""}</name>
        <description>${s.description||""}</description>
        <ExtendedData>
          <Data name="type"><value>${s.type||""}</value></Data>
          <Data name="transportModes"><value>${A}</value></Data>
          <Data name="gender"><value>${s.gender||""}</value></Data>
        </ExtendedData>
        <LineString>
          <coordinates>
            ${P}
          </coordinates>
        </LineString>
      </Placemark>
      `}).join(""),h=u.map(s=>{const b=p(s.transportModes);let P=Array.isArray(s.coordinates)?s.coordinates.slice():[];P.length&&(P[0][0]!==P[P.length-1][0]||P[0][1]!==P[P.length-1][1])&&P.push(P[0]);const A=P.map($=>`${$[1]},${$[0]},0`).join(" ");return`
    <Placemark>
      <name>${s.name||""}</name>
      <description>${s.description||""}</description>
      <ExtendedData>
        <Data name="type"><value>${s.type||""}</value></Data>
        <Data name="transportModes"><value>${b}</value></Data>
        <Data name="gender"><value>${s.gender||""}</value></Data>
        <Data name="restrictedTimes"><value>${s.restrictedTimes?JSON.stringify(s.restrictedTimes):""}</value></Data>
      </ExtendedData>
      <Polygon>
        <outerBoundaryIs>
          <LinearRing>
            <coordinates>
              ${A}
            </coordinates>
          </LinearRing>
        </outerBoundaryIs>
      </Polygon>
    </Placemark>
  `}).join("");c=f+S+w+h+k,t="application/vnd.google-earth.kml+xml",a="kml";break;case"csv":const x=`Type,Name,Description,PathType,TransportModes,Gender,Latitude,Longitude,Timestamp
`,M=o.map(s=>{const b=s.data||{};return["Point",`"${b.name||""}"`,`"${b.description||""}"`,"",`"${p(b.transportModes)}"`,`"${b.gender||""}"`,s.position[0],s.position[1],`"${s.timestamp}"`].join(",")}).join(`
`),D=d.map(s=>{const b=Array.isArray(s.coordinates)?typeof s.coordinates[0]=="object"&&Array.isArray(s.coordinates[0].coordinates)?s.coordinates.map($=>$.coordinates):s.coordinates:[],[P,A]=b[0]||["",""];return["Line",`"${s.name||""}"`,`"${s.description||""}"`,`"${s.type||""}"`,`"${p(s.transportModes)}"`,`"${s.gender||""}"`,P,A,`"${s.timestamp}"`].join(",")}).join(`
`),I=u.map(s=>{const b=Array.isArray(s.coordinates)?s.coordinates:[],[P,A]=b[0]||["",""];return["Polygon",`"${s.name||""}"`,`"${s.description||""}"`,`"${s.type||""}"`,`"${p(s.transportModes)}"`,`"${s.gender||""}"`,`"${s.restrictedTimes?JSON.stringify(s.restrictedTimes):""}"`,P,A,`"${s.timestamp||""}"`].join(",")}).join(`
`);c=x+M+(M&&(D||I)?`
`:"")+D+(D&&I?`
`:"")+I,t="text/csv",a="csv";break;default:const F={version:"1.0",exportDate:new Date().toISOString(),markers:o,paths:d};c=JSON.stringify(F,null,2),t="application/json",a="json"}const m=new Blob([c],{type:t}),j=URL.createObjectURL(m),y=`map_export_${new Date().toISOString().replace(/[:.]/g,"-")}.${a}`,l=document.createElement("a");l.href=j,l.download=y,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(j)},an=n=>new Promise((o,d)=>{const u=new FileReader;u.onload=c=>{let t;try{t=JSON.parse(c.target.result)}catch{return d(new Error("Invalid JSON"))}if(t.version&&t.markers&&t.paths){const a=JSON.parse(localStorage.getItem("mapMarkers")||"[]"),p=JSON.parse(localStorage.getItem("mapPaths")||"[]"),m=JSON.parse(localStorage.getItem("mapPolygons")||"[]"),j=t.markers.map(S=>({...S,id:crypto.randomUUID()})),y=t.paths.map(S=>({...S,id:crypto.randomUUID()})),l=Array.isArray(t.polygons)?t.polygons.map(S=>({...S,id:crypto.randomUUID()})):[],i=a.concat(j),f=p.concat(y),k=m.concat(l);return localStorage.setItem("mapMarkers",JSON.stringify(i)),localStorage.setItem("mapPaths",JSON.stringify(f)),localStorage.setItem("mapPolygons",JSON.stringify(k)),o({markers:i,paths:f,polygons:k})}if(t.type==="FeatureCollection"&&Array.isArray(t.features)){const a=JSON.parse(localStorage.getItem("mapMarkers")||"[]"),p=JSON.parse(localStorage.getItem("mapPaths")||"[]"),m=JSON.parse(localStorage.getItem("mapPolygons")||"[]"),j=[],y=[],l=[];t.features.forEach(S=>{const{geometry:w,properties:h={}}=S;if(w){if(w.type==="Point"){const[x,M]=w.coordinates;j.push({id:crypto.randomUUID(),position:[M,x],data:h,timestamp:h.timestamp||new Date().toISOString()})}else if(w.type==="LineString"){const x=w.coordinates.map(([M,D])=>[D,M]);y.push({id:crypto.randomUUID(),name:h.name||"",description:h.description||"",type:h.type||"",coordinates:x,timestamp:h.timestamp||new Date().toISOString()})}else if(w.type==="Polygon"){const x=w.coordinates[0].map(([M,D])=>[D,M]);l.push({id:crypto.randomUUID(),name:h.name||"",description:h.description||"",type:h.type||"",transportModes:h.transportModes||[],gender:h.gender||"",coordinates:x,timestamp:h.timestamp||new Date().toISOString()})}}});const i=a.concat(j),f=p.concat(y),k=m.concat(l);return localStorage.setItem("mapMarkers",JSON.stringify(i)),localStorage.setItem("mapPaths",JSON.stringify(f)),localStorage.setItem("mapPolygons",JSON.stringify(k)),o({markers:i,paths:f,polygons:k})}d(new Error("Invalid import file format"))},u.onerror=()=>d(new Error("File read error")),u.readAsText(n)});function ln({latitude:n,longitude:o},d,u){const t=d*(Math.PI/180),a=n(u*Math.cos(t))/6378137*(180/Math.PI),p=o(u*Math.sin(t))/(6378137*Math.cos(n*Math.PI/180))*(180/Math.PI);return{latitude:a,longitude:p}}function cn(){const[n,o]=g.useState(!1),[d,u]=g.useState([]),c=g.useRef(null),t=g.useRef(null),a=g.useRef(null),p=g.useRef(0);return g.useEffect(()=>{const y=l=>{typeof l.alpha=="number"&&(p.current=l.alpha)};return window.addEventListener("deviceorientation",y,!0),()=>window.removeEventListener("deviceorientation",y,!0)},[]),g.useEffect(()=>{if(!n)return;const y=navigator.geolocation.watchPosition(l=>{const{latitude:i,longitude:f,accuracy:k,speed:S,heading:w}=l.coords,h=l.timestamp;t.current={latitude:i,longitude:f,timestamp:h};let x=c.current;if(!x)x={latitude:i,longitude:f,timestamp:h};else if(a.current){const M=(h-a.current)/1e3,I=(typeof S=="number"&&S>0?S:1)*M,F=(360-p.current)%360;x=ln(x,F,I)}c.current=x,a.current=h,u(M=>[...M,{gps:{latitude:i,longitude:f,accuracy:k,speed:S,heading:w,timestamp:h},dr:{latitude:x.latitude,longitude:x.longitude,timestamp:h}}])},l=>{},{enableHighAccuracy:!0,maximumAge:0,timeout:15e3});return()=>{navigator.geolocation.clearWatch(y),c.current=null,t.current=null,a.current=null}},[n]),{tracking:n,points:d,start:()=>{u([]),o(!0),c.current=null,t.current=null,a.current=null},stop:()=>{o(!1)}}}function We(n,o){return n.map(d=>d[o]&&d[o].latitude&&d[o].longitude?[d[o].latitude,d[o].longitude]:null).filter(Boolean)}function dn(n){const o=`timestamp,gps_lat,gps_lng,gps_accuracy,dr_lat,dr_lng
`,d=n.map(a=>`${a.gps.timestamp},${a.gps.latitude},${a.gps.longitude},${a.gps.accuracy||""},${a.dr.latitude},${a.dr.longitude}`).join(`
`),u=new Blob([o+d],{type:"text/csv"}),c=URL.createObjectURL(u),t=document.createElement("a");t.href=c,t.download="dualtrack.csv",t.click()}function un(n){const o={type:"Feature",properties:{source:"gps"},geometry:{type:"LineString",coordinates:n.map(p=>[p.gps.longitude,p.gps.latitude])}},d={type:"Feature",properties:{source:"deadReckoning"},geometry:{type:"LineString",coordinates:n.map(p=>[p.dr.longitude,p.dr.latitude])}},u={type:"FeatureCollection",features:[o,d]},c=new Blob([JSON.stringify(u,null,2)],{type:"application/geo+json"}),t=URL.createObjectURL(c),a=document.createElement("a");a.href=t,a.download="dualtrack.geojson",a.click()}function pn({gps:n,dr:o,mode:d}){const u=He();return g.useEffect(()=>{d==="gps"&&n?u.setView([n.latitude,n.longitude],u.getZoom()):d==="dr"&&o&&u.setView([o.latitude,o.longitude],u.getZoom())},[n,o,d,u]),null}function hn({mode:n}){const{tracking:o,points:d,start:u,stop:c}=cn(),t=d.length?d[d.length-1].gps:null,a=d.length?d[d.length-1].dr:null,p=We(d,"gps"),m=We(d,"dr"),[j,y]=g.useState("off"),[l,i]=g.useState(null),[f,k]=g.useState(null),S=g.useRef(null),w=g.useRef(!1);return g.useEffect(()=>{n==="full"&&!o&&S.current&&navigator.geolocation.getCurrentPosition(h=>{const x=h.coords.latitude,M=h.coords.longitude;i({latitude:x,longitude:M}),S.current.setView([x,M],17),w.current=!0},h=>{console.warn("Failed to fetch initial GPS:",h)},{enableHighAccuracy:!0})},[n,o,S.current]),g.useEffect(()=>{const h=t||l;n==="full"&&h&&!w.current&&k(h),n!=="full"&&(w.current=!1)},[n,t,l]),e.jsxs(R,{sx:{height:"100%",display:"flex",flexDirection:"column",direction:"rtl"},children:[e.jsx(R,{sx:{textAlign:"center",py:1},children:e.jsx(_,{variant:"h6",fontSize:15,children:"مسیرآزمایشی مقایسه GPS و Dead Reckoning"})}),e.jsxs(R,{sx:{display:"flex",justifyContent:"center",gap:2,pb:1},children:[e.jsx(N,{title:o?"پایان مسیر":"شروع مسیر",children:e.jsx(E,{color:o?"error":"success",onClick:o?c:u,size:"large",children:o?e.jsx(Je,{}):e.jsx(Ue,{})})}),e.jsx(N,{title:"خروجی CSV",children:e.jsx("span",{children:e.jsx(E,{color:"success",disabled:!d.length,onClick:()=>dn(d),size:"large",children:e.jsx(vt,{})})})}),e.jsx(N,{title:"خروجی GeoJSON",children:e.jsx("span",{children:e.jsx(E,{color:"info",disabled:!d.length,onClick:()=>un(d),size:"large",children:e.jsx(Mt,{})})})})]}),e.jsxs(R,{sx:{flex:1,minHeight:0},children:[e.jsxs(Be,{center:p.length?p[p.length-1]:[36.2972,59.6067],zoom:16,style:{height:"100%",width:"100%"},whenCreated:h=>S.current=h,children:[e.jsx(Ve,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),e.jsx(ee,{positions:p,color:"blue",weight:5,opacity:.7}),e.jsx(ee,{positions:m,color:"orange",weight:4,opacity:.7,dashArray:"6 8"}),t&&e.jsx(ce,{center:[t.latitude,t.longitude],radius:6,color:"blue"}),a&&e.jsx(ce,{center:[a.latitude,a.longitude],radius:6,color:"orange"}),e.jsx(pn,{gps:t,dr:a,mode:j})]}),e.jsx(R,{sx:{position:"absolute",bottom:46,right:23,zIndex:1e3,backgroundColor:"#fff",borderRadius:"50%",boxShadow:"0 2px 8px rgba(0,0,0,0.2)"},children:e.jsx(N,{title:`دنبال‌کردن: ${j==="gps"?"GPS":j==="dr"?"DR":"خاموش"}`,children:e.jsx(E,{onClick:()=>y(h=>h==="off"?"gps":h==="gps"?"dr":"off"),color:j==="off"?"default":j==="gps"?"primary":"warning",size:"large",children:j==="gps"?e.jsx(wt,{}):j==="dr"?e.jsx(Ge,{}):e.jsx(Pt,{})})})})]}),d.length>0&&e.jsxs(R,{sx:{py:1,px:2},children:[e.jsxs(_,{variant:"subtitle2",children:["تعداد نقاط: ",d.length]}),e.jsxs(_,{variant:"body2",children:["آخرین GPS: ",t?`${t.latitude.toFixed(6)}, ${t.longitude.toFixed(6)}`:"-",e.jsx("br",{}),"آخرین Dead Reckoning: ",a?`${a.latitude.toFixed(6)}, ${a.longitude.toFixed(6)}`:"-",e.jsx("br",{}),"خطای لحظه‌ای (متر): ",t&&a?Math.sqrt(Math.pow((t.latitude-a.latitude)*111320,2)+Math.pow((t.longitude-a.longitude)*40075e3*Math.cos(t.latitude*Math.PI/180)/360,2)).toFixed(2):"-"]})]})]})}function gn({isTracking:n,onStartTracking:o,onStopTracking:d,onAddMarker:u,onExport:c,onImportClick:t,onFilter:a,onStartManualPath:p,isDrawingPath:m,onStartPolygon:j,isDrawingPolygon:y,onPanelToggle:l}){const i=Ct(),k=Dt(i.breakpoints.down("sm"))?"small":"medium",[S,w]=g.useState(null),h=A=>{w(A.currentTarget)},x=A=>{w(null),A&&typeof c=="function"&&c(A)},[M,D]=g.useState(!1),[I,F]=g.useState("closed"),s=I!=="closed",b=()=>{F(I==="full"?"compact":"full"),l&&l(!0)},P=()=>{F("closed"),l&&l(!1)};return e.jsxs(Ot,{position:"fixed",color:"inherit",sx:{top:"auto",bottom:0},children:[e.jsxs(It,{sx:{justifyContent:"space-around"},children:[e.jsx(N,{title:n?"توقف ردیابی":"شروع ردیابی",arrow:!0,children:e.jsx(E,{color:n?"error":"success",onClick:n?d:o,size:k,children:n?e.jsx(Je,{}):e.jsx(Ue,{})})}),e.jsx(N,{title:"نشانگر",arrow:!0,children:e.jsx(E,{color:"primary",onClick:u,size:k,children:e.jsx(At,{})})}),e.jsx(N,{title:"مسیر دستی",arrow:!0,children:e.jsx(E,{color:m?"success":"primary",onClick:p,size:k,children:e.jsx(Tt,{})})}),e.jsx(N,{title:y?"در حال ترسیم محدوده":"محدوده جدید",arrow:!0,children:e.jsx(E,{color:y?"success":"primary",onClick:j,size:k,children:e.jsx(Et,{})})}),e.jsx(N,{title:"فیلتر",arrow:!0,children:e.jsx(E,{color:"secondary",onClick:a,size:k,children:e.jsx(Lt,{})})}),e.jsx(N,{title:"خروجی",arrow:!0,children:e.jsx(E,{color:"warning",onClick:h,size:k,children:e.jsx(Rt,{})})}),e.jsxs($t,{anchorEl:S,open:!!S,onClose:()=>x(),children:[e.jsxs(T,{onClick:()=>x("geojson"),children:[e.jsx(ie,{children:e.jsx(Nt,{fontSize:"small"})}),e.jsx(le,{children:"GeoJSON"})]}),e.jsxs(T,{onClick:()=>x("kml"),children:[e.jsx(ie,{children:e.jsx(Ft,{fontSize:"small"})}),e.jsx(le,{children:"KML"})]}),e.jsxs(T,{onClick:()=>x("csv"),children:[e.jsx(ie,{children:e.jsx(Ne,{fontSize:"small"})}),e.jsx(le,{children:"CSV"})]}),e.jsxs(T,{onClick:()=>x("json"),children:[e.jsx(ie,{children:e.jsx(Ne,{fontSize:"small"})}),e.jsx(le,{children:"JSON"})]})]}),e.jsx(N,{title:"ورودی",arrow:!0,children:e.jsx(E,{color:"inherit",onClick:t,size:k,children:e.jsx(Wt,{})})}),e.jsx(N,{title:"تست مسیر GPS/DR",arrow:!0,children:e.jsx(E,{color:"info",onClick:()=>{F("full"),l&&l(!0)},size:"large",children:e.jsx(Ge,{})})})]}),e.jsx(zt,{direction:"up",in:s,mountOnEnter:!0,unmountOnExit:!0,children:e.jsxs(ze,{elevation:20,sx:{position:"fixed",left:0,right:0,bottom:0,height:I==="full"?"100dvh":"25vh",borderTopLeftRadius:24,borderTopRightRadius:24,zIndex:2e4,bgcolor:"background.paper",boxShadow:16,display:"flex",flexDirection:"column",pt:1,pb:1},children:[e.jsxs(R,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",px:2},children:[e.jsx(N,{title:"بستن",children:e.jsx(E,{onClick:P,children:"×"})}),e.jsx(_,{sx:{fontWeight:"bold",fontSize:"16px"},children:"تست مسیر GPS/DR"}),e.jsx(N,{title:I==="full"?"حالت کوچک":"تمام صفحه",children:e.jsx(E,{onClick:b,children:I==="full"?e.jsx(Jt,{}):e.jsx(Ut,{})})})]}),e.jsx(R,{sx:{flex:1,minHeight:0,px:2,pb:2},children:e.jsx(hn,{mode:I})})]})})]})}const mn=Bt.divIcon({className:"custom-marker-icon",html:`
    <div style="
      width: 30px; 
      height: 30px; 
      background-color: #2196F3; 
      border-radius: 50%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      color: white; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    ">
      📍
    </div>
  `,iconSize:[30,30],iconAnchor:[15,15]});function xn({onMapClick:n}){return Ht({click:o=>{n(o.latlng)}}),null}function fn({position:n,zoom:o}){const d=He();return g.useEffect(()=>{n&&d.setView(n,o)},[n,o]),null}const jn=()=>{const[n,o]=g.useState([36.2972,59.6067]),[d,u]=g.useState(12),[c,t]=g.useState(null),[a,p]=g.useState(null),[m,j]=g.useState([]),[y,l]=g.useState(null),[i,f]=g.useState(null),[k,S]=g.useState(!1),[w,h]=g.useState(!1),[x,M]=g.useState(null),[D,I]=g.useState(!1),[F,s]=g.useState("street"),b=g.useRef(null),[P,A]=g.useState(null),[$,ne]=g.useState(!1),[X,re]=g.useState([]),[Ze,Me]=g.useState([]),[me,xe]=g.useState(null),[se,fe]=g.useState(!1),[Q,je]=g.useState([]),[we,ye]=g.useState(!1),be=g.useRef(!1),{polygons:Pe,addPolygon:Ce,removePolygon:De}=sn(),[qe,Ke]=g.useState(!1),Xe=(r="json")=>{on(r)},[B,Qe]=g.useState({markerTypes:[],pathTypes:[],transportModes:[],gender:[]}),Ye={street:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",satellite:"https://tiles.maps.eox.at/wmts/1.0.0/s2cloudless-2020_3857/default/g/{z}/{y}/{x}.jpg"},{markers:Oe,addMarker:Ie,removeMarker:Ae}=nn(),{paths:Te,addPath:ke,removePath:Ee}=rn(),oe=g.useRef(null),Le=g.useCallback(()=>{if(l(null),!navigator.geolocation){l("موقعیت مکانی در دستگاه شما پشتیبانی نمی‌شود");return}const r={enableHighAccuracy:!0,timeout:3e4,maximumAge:0};navigator.geolocation.getCurrentPosition(v=>{const{latitude:V,longitude:Z,accuracy:G}=v.coords,O=[V,Z];t(O),A(v),p(G),o(O),u(15)},v=>{switch(v.code){case v.PERMISSION_DENIED:l("دسترسی به موقعیت مکانی رد شد");break;case v.POSITION_UNAVAILABLE:l("اطلاعات موقعیت در دسترس نیست");break;case v.TIMEOUT:l("زمان درخواست موقعیت مکانی به پایان رسید");break;default:l("خطا در دریافت موقعیت مکانی")}o([36.2972,59.6067]),u(12)},r)},[]),et=()=>{ne(!0),re([]),l(null)},tt=()=>{X.length>1?(ne(!1),xe("manual"),h(!0)):l("مسیر بسیار کوتاه است. حداقل دو نقطه نیاز است.")},nt=g.useRef(m),rt=()=>{fe(!0),je([])},st=()=>{Q.length>=3?(fe(!1),ye(!0)):alert("حداقل سه نقطه نیاز است.")},ot=r=>{Ce(r),ye(!1),je([]),fe(!1)};g.useEffect(()=>{nt.current=m},[m]);const at=()=>{S(!0),j([]),l(null),b.current&&clearTimeout(b.current),b.current=setTimeout(()=>{j(r=>(r.length===0&&(Se(),l("عدم موفقیت در دریافت موقعیت مکانی. لطفاً مجدداً تلاش کنید.")),r))},3e4),oe.current=navigator.geolocation.watchPosition(r=>{console.log("GPS update:",r.coords.latitude,r.coords.longitude,"accuracy:",r.coords.accuracy),A(r);const{latitude:v,longitude:V,accuracy:Z,altitude:G,speed:O,heading:ae}=r.coords,Y=[v,V];clearTimeout(b.current),Z<=5e3&&(t(Y),l(null),j(q=>{if(q.length===0)return[...q,Y];const Re=q[q.length-1],$e=1e-6;return Math.abs(Re[0]-v)>$e||Math.abs(Re[1]-V)>$e?[...q,Y]:q}),Me(q=>[...q,{coords:{latitude:v,longitude:V,accuracy:Z,altitude:G,speed:O,heading:ae},timestamp:r.timestamp}]))},r=>{console.error("Tracking error:",r),clearTimeout(b.current);let v="خطا در دریافت موقعیت";switch(r.code){case r.PERMISSION_DENIED:v="دسترسی به موقعیت مکانی رد شد";break;case r.POSITION_UNAVAILABLE:v="اطلاعات موقعیت در دسترس نیست";break;case r.TIMEOUT:v="زمان درخواست موقعیت مکانی به پایان رسید";break}l(v),Se()},{enableHighAccuracy:!0,timeout:3e4,maximumAge:0,distanceFilter:1})},Se=()=>{oe.current&&(navigator.geolocation.clearWatch(oe.current),oe.current=null),S(!1),m.length>1?(xe("gps"),h(!0)):(j([]),l("مسیر بسیار کوتاه است. لطفاً مسافت بیشتری را طی کنید."))},it=r=>{M({type:"marker",item:r})},lt=r=>{M({type:"path",item:r})},ct=()=>{if(x){const{type:r,item:v}=x;r==="marker"?Ae(v.id):r==="path"?Ee(v.id):r==="polygon"&&De(v.id),M(null)}},dt=r=>{ke({...r,coordinates:m,pointsMeta:Ze}),h(!1),j([]),Me([])};g.useEffect(()=>{Le()},[Le]);const ut=r=>{if(be.current){be.current=!1;return}if(!(x||we||w||i)){if(se){je(v=>[...v,[r.lat,r.lng]]);return}if($){re(v=>[...v,{coordinates:[r.lat,r.lng],gpsMeta:P?{coords:{...P.coords},timestamp:P.timestamp}:null}]);return}f({lat:r.lat,lng:r.lng})}},pt=r=>{Ie({position:[r.latitude,r.longitude],data:r}),f(null)},ht=r=>{const v=r.target.files[0];v&&an(v).then(({markers:V,paths:Z,polygons:G})=>{Oe.forEach(O=>Ae(O.id)),Te.forEach(O=>Ee(O.id)),Pe.forEach(O=>De(O.id)),V.forEach(O=>Ie(O)),Z.forEach(O=>ke(O)),G&&G.forEach(O=>Ce(O)),alert("اطلاعات با موفقیت وارد شد!")})},gt=Oe.filter(r=>{var G,O,ae;const v=B.markerTypes.length===0||B.markerTypes.includes((G=r.data)==null?void 0:G.type),V=B.transportModes.length===0||((O=r.data)==null?void 0:O.transportModes)&&r.data.transportModes.some(Y=>B.transportModes.includes(Y)),Z=B.gender.length===0||B.gender.includes((ae=r.data)==null?void 0:ae.gender);return v&&V&&Z}),mt=Te.filter(r=>B.pathTypes.length===0||B.pathTypes.includes(r.type)),xt=r=>{ke({...r,coordinates:X}),h(!1),re([]),ne(!1)},ft=r=>{switch(r){case"hiking":return"#4CAF50";case"cycling":return"#2196F3";case"driving":return"#FF9800";default:return"#9C27B0"}};return e.jsxs("div",{className:"map-container",children:[e.jsx(R,{sx:{position:"absolute",top:"10px",right:"10px",backgroundColor:"#ffffffee",padding:"10px",borderRadius:"8px",zIndex:qe?500:1200,boxShadow:"0 2px 6px rgba(0,0,0,0.15)",direction:"rtl",minWidth:"180px"},children:e.jsxs(z,{fullWidth:!0,variant:"outlined",size:"small",children:[e.jsx(J,{id:"map-layer-label",style:{right:"0px",fontWeight:"bold"},children:"نقشه پایه"}),e.jsxs(he,{labelId:"map-layer-label",id:"map-layer-select",value:F,label:"نقشه پایه",onChange:r=>s(r.target.value),children:[e.jsx(T,{value:"street",children:"Street View"}),e.jsx(T,{value:"satellite",children:"Satellite View"})]})]})}),w&&e.jsx(qt,{onSave:me==="manual"?xt:dt,onClose:()=>{h(!1),me==="manual"?(re([]),ne(!1)):j([]),xe(null)},pathCoordinates:me==="manual"?X:m}),i&&e.jsx(Zt,{location:i,gpsMeta:P,onClose:()=>f(null),onSave:pt}),D&&e.jsx(en,{isOpen:D,onClose:()=>I(!1),filterOptions:B,setFilterOptions:Qe}),x&&e.jsx(tn,{selectedItem:x,onDelete:ct,onClose:()=>M(null)}),e.jsxs(Be,{center:n,zoom:d,scrollWheelZoom:!0,style:{width:"100%",height:"100%",position:"absolute",margin:0,padding:0,direction:"rtl"},children:[e.jsx(fn,{position:n,zoom:d}),e.jsx(xn,{onMapClick:ut}),e.jsx(Ve,{url:Ye[F],attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}),c&&a&&e.jsxs(e.Fragment,{children:[e.jsx(ce,{center:c,radius:a,color:"blue",fillColor:"blue",fillOpacity:.1,weight:2}),e.jsx(ce,{center:c,radius:5,color:"blue",fillColor:"blue",fillOpacity:1,weight:0})]}),m.length>0&&e.jsx(ee,{positions:m,color:"blue",weight:5,opacity:k?.7:1}),$&&X.length>0&&e.jsx(ee,{positions:X.map(r=>r.coordinates),color:"blue",weight:5,opacity:.7}),se&&Q.length>1&&e.jsx(Fe,{positions:Q,pathOptions:{color:"purple",fillOpacity:.2}}),Pe.map(r=>e.jsx(Fe,{positions:r.coordinates,pathOptions:{color:"purple",fillOpacity:.2},eventHandlers:{click:v=>{v.originalEvent&&v.originalEvent.stopPropagation&&v.originalEvent.stopPropagation(),be.current=!0,M({type:"polygon",item:r})}}},r.id)),we&&e.jsx(Xt,{onSave:ot,onClose:()=>ye(!1),polygonCoordinates:Q}),gt.map(r=>e.jsx(Vt,{position:r.position,icon:mn,eventHandlers:{click:()=>it(r)}},r.id)),mt.map(r=>(Array.isArray(r.coordinates)&&typeof r.coordinates[0]=="object"&&Array.isArray(r.coordinates[0].coordinates)?r.coordinates.map(v=>v.coordinates):Array.isArray(r.coordinates[0])&&r.coordinates,e.jsx(_e.Fragment,{children:e.jsx(ee,{positions:Array.isArray(r.coordinates)&&r.coordinates.length>0?typeof r.coordinates[0]=="object"&&Array.isArray(r.coordinates[0].coordinates)?r.coordinates.map(v=>v.coordinates):r.coordinates:[],color:ft(r.type),weight:5,opacity:.7,eventHandlers:{click:()=>lt(r)},children:e.jsx(Gt,{children:e.jsxs("div",{children:[e.jsx("strong",{children:r.name}),e.jsx("p",{children:r.description}),e.jsxs("p",{children:["نوع مسیر: ",r.type]})]})})})},r.id)))]}),e.jsx(gn,{isTracking:k,onStartTracking:at,onStopTracking:Se,onAddMarker:()=>f({lat:n[0],lng:n[1]}),onExport:Xe,onImportClick:()=>document.getElementById("importInput").click(),onFilter:()=>I(!0),onStartManualPath:et,isDrawingPath:$,onStartPolygon:rt,isDrawingPolygon:se,onPanelToggle:Ke}),$&&e.jsx(U,{onClick:tt,variant:"contained",color:"success",style:{position:"fixed",bottom:70,right:20,zIndex:9999},children:"پایان مسیر و ذخیره"}),se&&Q.length>=3&&e.jsx(U,{onClick:st,variant:"contained",color:"success",style:{position:"fixed",bottom:70,right:90,zIndex:9999},children:"پایان محدوده و ذخیره"}),e.jsx("input",{id:"importInput",type:"file",accept:".json",onChange:ht,style:{display:"none"}})]})};_t.createRoot(document.getElementById("root")).render(e.jsx(_e.StrictMode,{children:e.jsx(jn,{})}));
